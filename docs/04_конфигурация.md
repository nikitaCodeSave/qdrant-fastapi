# Конфигурация

## Обзор

Конфигурация приложения реализована через `pydantic-settings`. Настройки загружаются из:

1. **Переменные окружения** (высший приоритет)
2. **Файл .env**
3. **Значения по умолчанию** (низший приоритет)

Файл конфигурации: `src/config.py`

## Все параметры

### Application

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `PROJECT_NAME` | str | "Qdrant RAG Service" | Название проекта (отображается в API docs) |
| `VERSION` | str | "0.1.0" | Версия приложения |
| `ENVIRONMENT` | str | "development" | Окружение: `development`, `staging`, `production` |

### API

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `API_PREFIX` | str | "/api/v1" | Префикс для всех API endpoints |

### Qdrant Connection

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `QDRANT_HOST` | str | "localhost" | Хост Qdrant сервера |
| `QDRANT_PORT` | int | 6333 | REST API порт |
| `QDRANT_GRPC_PORT` | int | 6334 | gRPC порт |
| `QDRANT_API_KEY` | str | None | API ключ (для Qdrant Cloud) |
| `QDRANT_PREFER_GRPC` | bool | True | Использовать gRPC (быстрее для bulk операций) |
| `QDRANT_TIMEOUT` | float | 30.0 | Таймаут операций в секундах |
| `QDRANT_HTTPS` | bool | False | Использовать HTTPS |
| `QDRANT_LOCAL_PATH` | str | None | Путь для локального хранилища (embedded mode) |

### Qdrant Defaults

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `QDRANT_DEFAULT_COLLECTION` | str | "documents" | Имя коллекции по умолчанию |
| `QDRANT_VECTOR_SIZE` | int | 1024 | Размерность векторов (1024 для e5-large, 1536 для OpenAI) |
| `QDRANT_DISTANCE` | str | "Cosine" | Метрика расстояния: `Cosine`, `Euclid`, `Dot` |

## Вычисляемые поля

Некоторые поля вычисляются автоматически:

```python
@computed_field
@property
def qdrant_url(self) -> str:
    """URL для REST API Qdrant."""
    scheme = "https" if self.qdrant_https else "http"
    return f"{scheme}://{self.qdrant_host}:{self.qdrant_port}"

@computed_field
@property
def is_local_mode(self) -> bool:
    """Использовать embedded Qdrant без сервера."""
    return self.qdrant_local_path is not None

@computed_field
@property
def is_production(self) -> bool:
    """Проверка production окружения."""
    return self.environment == "production"
```

## Примеры конфигураций

### Development (Local Mode)

```env
# .env
ENVIRONMENT=development
QDRANT_LOCAL_PATH=./qdrant_storage
```

Qdrant хранит данные локально, Docker не нужен.

### Development (Docker)

```env
# .env
ENVIRONMENT=development
QDRANT_HOST=localhost
QDRANT_PORT=6333
QDRANT_GRPC_PORT=6334
QDRANT_PREFER_GRPC=true
```

Qdrant запущен в Docker:

```bash
docker run -p 6333:6333 -p 6334:6334 qdrant/qdrant
```

### Production (Qdrant Cloud)

```env
# .env
ENVIRONMENT=production
QDRANT_HOST=your-cluster.cloud.qdrant.io
QDRANT_PORT=6333
QDRANT_API_KEY=your-api-key-here
QDRANT_HTTPS=true
QDRANT_PREFER_GRPC=true
```

### Production (Self-hosted)

```env
# .env
ENVIRONMENT=production
QDRANT_HOST=qdrant.internal.company.com
QDRANT_PORT=6333
QDRANT_API_KEY=your-internal-key
QDRANT_TIMEOUT=60.0
```

## Использование в коде

### Импорт настроек

```python
from src.config import settings

# Доступ к параметрам
print(settings.qdrant_url)       # http://localhost:6333
print(settings.is_production)     # False
print(settings.api_prefix)        # /api/v1
```

### Получение параметров клиента

```python
# Метод возвращает kwargs для AsyncQdrantClient
client_kwargs = settings.get_qdrant_client_kwargs()

# Для Local Mode:
# {"path": "./qdrant_storage"}

# Для Server Mode:
# {
#     "host": "localhost",
#     "port": 6333,
#     "grpc_port": 6334,
#     "api_key": None,
#     "prefer_grpc": True,
#     "timeout": 30.0,
#     "https": False,
# }
```

### Singleton паттерн

```python
from src.config import get_settings

# Функция кэширована через lru_cache
settings1 = get_settings()
settings2 = get_settings()
assert settings1 is settings2  # True - один экземпляр
```

### Сброс кэша (для тестов)

```python
from src.config import get_settings

# Сброс для повторной загрузки настроек
get_settings.cache_clear()
```

## Поведение в разных окружениях

### Development

- Swagger UI доступен по `/docs`
- ReDoc доступен по `/redoc`
- Debug логирование
- Можно использовать Local Mode

### Production

- Swagger UI и ReDoc отключены
- Info логирование
- Рекомендуется Server Mode с API ключом

```python
# В main.py
app = FastAPI(
    docs_url="/docs" if not settings.is_production else None,
    redoc_url="/redoc" if not settings.is_production else None,
    openapi_url="/openapi.json" if not settings.is_production else None,
)
```

## Логирование

Уровень логирования определяется окружением:

```python
logging.basicConfig(
    level=logging.DEBUG if not settings.is_production else logging.INFO,
    format="%(asctime)s | %(levelname)-8s | %(name)s | %(message)s",
)
```

## Валидация

Pydantic валидирует настройки при загрузке:

```python
class Settings(BaseSettings):
    qdrant_port: int = Field(default=6333, ge=1, le=65535)
    qdrant_timeout: float = Field(default=30.0, gt=0)
    environment: Literal["development", "staging", "production"]
```

При невалидных значениях будет выброшено исключение при старте приложения.

## Переменные окружения vs .env

Переменные окружения имеют приоритет над `.env`:

```bash
# .env
QDRANT_HOST=localhost

# Команда запуска (перезапишет .env)
QDRANT_HOST=remote-server uvicorn src.main:app
```

## Безопасность

### Чувствительные данные

Никогда не храните в git:
- `QDRANT_API_KEY`
- Любые credentials

```gitignore
# .gitignore
.env
*.pem
*.key
```

### Production checklist

1. `ENVIRONMENT=production`
2. `QDRANT_API_KEY` установлен
3. `QDRANT_HTTPS=true` для cloud/remote
4. `.env` не в git

## Следующие разделы

- [API Reference](05_api_reference.md) — работа с endpoints
- [Схемы данных](06_схемы_данных.md) — Pydantic модели
